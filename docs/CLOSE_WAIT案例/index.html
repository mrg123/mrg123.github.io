<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.56">
<title data-react-helmet="true">记录一次CLOSE_WAIT案例 | mrg123.com</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="记录一次CLOSE_WAIT案例 | mrg123.com"><meta data-react-helmet="true" name="description" content="现有的系统架构基于nginx 网管反向代理 +  web服务器使用apache + php + mysql 阿里云RDS"><meta data-react-helmet="true" property="og:description" content="现有的系统架构基于nginx 网管反向代理 +  web服务器使用apache + php + mysql 阿里云RDS"><meta data-react-helmet="true" property="og:url" content="https://mrg123.github.io/docs/CLOSE_WAIT案例"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://mrg123.github.io/docs/CLOSE_WAIT案例"><link rel="stylesheet" href="/styles.45b1cdf6.css">
<link rel="preload" href="/styles.0dbef26b.js" as="script">
<link rel="preload" href="/runtime~main.dca743ad.js" as="script">
<link rel="preload" href="/main.3f0f9fa8.js" as="script">
<link rel="preload" href="/1.cea16bf7.js" as="script">
<link rel="preload" href="/2.628b2e7a.js" as="script">
<link rel="preload" href="/3.40cc713f.js" as="script">
<link rel="preload" href="/1be78505.8a2bda4b.js" as="script">
<link rel="preload" href="/40.5f3e37f9.js" as="script">
<link rel="preload" href="/20ac7829.4afa0427.js" as="script">
<link rel="preload" href="/d30adc70.eec1c213.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">My Doc Share</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/精准定位问题">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mrg123/mrg123.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">My Doc Share</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/精准定位问题">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/mrg123/mrg123.github.io" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Apache</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/htaccess">.htaccess配置</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/apache-vhost">vhost常见配置</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/apache常见问题">apache常见问题</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/apache配置ssl证书">apache配置ssl证书</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/http转https">http转https</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Case</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/命令行终端设置代理">命令行终端设置代理 windows / mac / linux</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/CLOSE_WAIT案例">记录一次CLOSE_WAIT案例</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/精准定位问题">如何分析问题?如何聪明的提问</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">工具</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/安装sonar">使用window10 安装sonar扫描代码</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">系统</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/安装kali桌面">安装kali桌面</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Test</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/doc1">Style Guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/doc2">Document Number 2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/doc3">This is Document Number 3</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">记录一次CLOSE_WAIT案例</h1></header><div class="markdown"><p>现有的系统架构基于nginx 网管反向代理 +  web服务器使用apache + php + mysql 阿里云RDS</p><p>现有方案考虑更换成 nginx 网管反向代理 + web服务器 nginx + php-fpm +php + mysql  阿里云RDS</p><p>PHP 7.0版本 apache 2.4版本</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="问题"></a>问题<a aria-hidden="true" tabindex="-1" class="hash-link" href="#问题" title="Direct link to heading">#</a></h2><ol><li>发布代码可能导致系统出现502</li><li>owms,hms请求wms服务器,会出现大量的CLOSE_WAIT状态的tcp请求,请求量大的情况下,会导致连接池占满,无法处理请求,服务器出现502</li><li>请求owms服务器,有概率出现502</li><li>apache存在错误,进程异常退出,php模块异常,内存泄漏等问题</li><li>大量的CLOSE_WAIT一定时应用程序出现问题,如果是java或者.net语言的应用可以考虑是否socks未正常关闭导致的问题</li></ol><p>问题1 - 发布出现502</p><p><img src="../static/img/502_1.jpg" alt="502_1"> </p><p>问题2 - 大量请求502  - grafana 分析web服务器的性能日志大量CLOSE_WAIT tcp进程,占用链接池</p><p><img src="../static/img/502_2.png" alt="502_2"></p><p>问题3 - 请求随机502 - kibana分析apache访问日志,随机502</p><p><img src="../static/img/502_3.png" alt="502_3"></p><p>问题4 -  apache错误日志</p><p><img src="../static/img/502_4.png" alt="502_4"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="解决方案"></a>解决方案<a aria-hidden="true" tabindex="-1" class="hash-link" href="#解决方案" title="Direct link to heading">#</a></h2><p>1 停用apache,使用php-fpm替换</p><p>2 PHP程序使用的curl,有close,排查应用问题,可能时apache底层问题或者PHP插件问题</p><p>理由,FPM更稳定,支持更大的请求</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="临时的解决方案"></a>临时的解决方案<a aria-hidden="true" tabindex="-1" class="hash-link" href="#临时的解决方案" title="Direct link to heading">#</a></h2><ol><li>设置MaxRequestWorkers =1000 这个只是延迟了事故发生,如果服务器再次耗尽内存,问题依旧会发生</li><li>如果请求量不多,可以切换apache的工作模式,看能否解决,修改apache工作模式 切换到 prefork  </li><li>http请求的头部设置 &#x27;&#x27;Connection&#x27;  =&gt; &#x27;close&#x27;</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="查看服务器当前tcp-close_wait状态的进程"></a>查看服务器当前TCP CLOSE_WAIT状态的进程<a aria-hidden="true" tabindex="-1" class="hash-link" href="#查看服务器当前tcp-close_wait状态的进程" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">netstat -antp | grep CLOSE_WAIT</span></div></div></div></div></div><p>随机端口的服务器为客户端,另一个服务器为服务端</p><p><img src="../static/img/close-wait01.png" alt="close-wait01"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="使用tcpdump命令导出请求日志"></a>使用tcpdump命令导出请求日志<a aria-hidden="true" tabindex="-1" class="hash-link" href="#使用tcpdump命令导出请求日志" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tcpdump  -w   /path/log.cap</span></div></div></div></div></div><p>导出文件后,可以下载软件wireshark分析tcp请求日志</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="tcp进程池满了apache错误日志"></a>tcp进程池满了apache错误日志<a aria-hidden="true" tabindex="-1" class="hash-link" href="#tcp进程池满了apache错误日志" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Sat May 16 04:16:51.913919 2020] [mpm_event:error] [pid 24619:tid 140552500967168] AH03490: scoreboard is full, not at MaxRequestWorkers.Increase ServerLimit.</span></div></div></div></div></div><p>因为CLOSE_WAIT太多,导致tcp进程池满了,服务端无法再服务</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="close_wait故障分析"></a>CLOSE_WAIT故障分析<a aria-hidden="true" tabindex="-1" class="hash-link" href="#close_wait故障分析" title="Direct link to heading">#</a></h2><p>客户端发起的挥手请求,服务端返回确认后,进入CLOST_WAIT但是应用关闭失败,第三次挥手请求没有发送出去导致进程停留在CLOST_WAIT状态,客户端TCP停留在FIN-WAIT-2状态,因为 Linux 有一个「tcp_fin_timeout」设置,控制了 FIN_WAIT2 的最大生命周期.所以客户端不会出现阻塞情况</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="tcp三次握手"></a>TCP三次握手<a aria-hidden="true" tabindex="-1" class="hash-link" href="#tcp三次握手" title="Direct link to heading">#</a></h2><p><img src="../static/img/TCP-%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpg" alt="TCP-四次挥手"></p><p><em>握手请求发起方一定是客户端</em></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="tcp四次挥手"></a>TCP四次挥手<a aria-hidden="true" tabindex="-1" class="hash-link" href="#tcp四次挥手" title="Direct link to heading">#</a></h2><p><img src="../static/img/TCP-%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpg" alt="TCP-四次挥手"></p><p><em>挥手请求可以是客户端发起也可以是服务端发起</em></p><p><em>客户端请求头部设置&#x27;&#x27;Connection&#x27;  =&gt; &#x27;close&#x27; 后,也会主动发起挥手,但是服务端不一定会确认,也可以再次发起挥手到客户端</em></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="tcp通信数据包分析"></a>TCP通信数据包分析<a aria-hidden="true" tabindex="-1" class="hash-link" href="#tcp通信数据包分析" title="Direct link to heading">#</a></h2><ul><li>114:12:45.104687  时间带有精确到微妙</li><li>localhost.39870 &gt; localhost.9502 表示通信的流向，39870是客户端的随机接口，9502是服务器端,固定端口</li><li>[S] 表示这是一个SYN请求</li><li>[S.] 表示这是一个SYN+ACK确认包: </li><li>[.] 表示这是一个ACT确认包， (client)SYN-&gt;(server)SYN-&gt;(client)ACT 就是3次握手过程</li><li>[P] 表示这个是一个数据推送，可以是从服务器端向客户端推送，也可以从客户端向服务器端推</li><li>[F] 表示这是一个FIN包，是关闭连接操作，client/server都有可能发起</li><li>[R] 表示这是一个RST包，与F包作用相同，但RST表示连接关闭时，仍然有数据未被处理。可以理解为是强制切断</li><li>win 4099 是指滑动窗口大小</li><li>length 18指数据包的大小</li></ul><p>1 客户端49492 服务端60081
客户端发起请求 第一次握手 [S]  SYN = 1, seq = 2396311514</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:18.895072 IP 10.10.10.10.49492 &gt; 10.10.10.159.600: Flags [S], seq 2396311514, win 29200, options [mss 1460,sackOK,TS val 429550635 ecr 0,nop,wscale 7], length 0</span></div></div></div></div></div><p>2 服务端确认 第二次握手  [S.]  SYN=1,ACK=1, ack = 2396311514+1 ,seq = 2480093606, </p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:19.042847 IP 10.10.10.159.600 &gt; 10.10.10.10.49492: Flags [S.], seq 2480093606, ack 2396311515, win 28960, options [mss 1460,sackOK,TS val 500389019 ecr 429550635,nop,wscale 7], length 0</span></div></div></div></div></div><p>3 客户端确认 第三次握手 [.] ACK=1, ack=1 | 客户端收到了服务端的SYN+ACK包,向服务端发送确认包ACK(ack=2480093606+1)</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:19.042858 IP 10.10.10.10.49492 &gt; 10.10.10.159.600: Flags [.], ack 1, win 229, options [nop,nop,TS val 429550672 ecr 500389019], length 0</span></div></div></div></div></div><p>客户端和服务端进入 ESTABLISHED 状态,进行数据的双向通信</p><p>4 客户端发送数据包 [P.] 702字节长度的数据 </p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:19.042888 IP 10.10.10.10.49492 &gt; 10.10.10.159.600: Flags [P.], seq 1:703, ack 1, win 229, options [nop,nop,TS val 429550672 ecr 500389019], length 702</span></div></div></div></div></div><p>5 客户端再次发送数据包 [P.]  702字节长度的数据 </p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:19.461644 IP 10.10.10.10.49492 &gt; 10.10.10.159.600: Flags [P.], seq 1:703, ack 1, win 229, options [nop,nop,TS val 429550777 ecr 500389019], length 702</span></div></div></div></div></div><p>6 服务端确认收到数据 </p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:19.609433 IP 10.10.10.159.600 &gt; 10.10.10.10.49492: Flags [.], ack 703, win 238, options [nop,nop,TS val 500389161 ecr 429550777], length 0</span></div></div></div></div></div><p>7 服务端发送数据包 [P.] 1056字节长度的数据</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:19.625753 IP 10.10.10.159.600 &gt; 10.10.10.10.49492: Flags [P.], seq 1:1057, ack 703, win 238, options [nop,nop,TS val 500389165 ecr 429550777], length 1056</span></div></div></div></div></div><p>8 客户端确认收到数据</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:19.625760 IP 10.10.10.10.49492 &gt; 10.10.10.159.600: Flags [.], ack 1057, win 245, options [nop,nop,TS val 429550818 ecr 500389165], length 0</span></div></div></div></div></div><p>9  服务端再次发送数据 1056字节长度的数据</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:20.764275 IP 10.10.10.159.600 &gt; 10.10.10.10.49492: Flags [P.], seq 1:1057, ack 703, win 238, options [nop,nop,TS val 500389450 ecr 429550777], length 1056</span></div></div></div></div></div><p>10 客户端表示收到数据</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:34:20.764281 IP 10.10.10.10.49492 &gt; 10.10.10.159.600: Flags [.], ack 1057, win 245, options [nop,nop,TS val 429551102 ecr 500389450,nop,nop,sack 1 {1:1057}], length 0</span></div></div></div></div></div><p>以上是握手请求和数据传输的tcp包通信记录,接下来还有四次挥手记录,才能完成整个TCP请求</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="close_wait-tcp包通信请求分析"></a>CLOSE_WAIT TCP包通信请求分析<a aria-hidden="true" tabindex="-1" class="hash-link" href="#close_wait-tcp包通信请求分析" title="Direct link to heading">#</a></h2><p>三次握手请求完成:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:28:14.661683 IP client.45068 &gt; server: Flags [S], seq 2644197498, win 29200, options [mss 1460,sackOK,TS val 451059577 ecr 0,nop,wscale 7], length 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:28:14.809077 IP server &gt; client.45068: Flags [S.], seq 1368176130, ack 2644197499, win 28960, options [mss 1460,sackOK,TS val 521897961 ecr 451059577,nop,wscale 7], length 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:28:14.809088 IP client.45068 &gt; server: Flags [.], ack 1, win 229, options [nop,nop,TS val 451059613 ecr 521897961], length 0</span></div></div></div></div></div><p>开始传输数据:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:28:14.809124 IP client.45068 &gt; server: Flags [P.], seq 1:702, ack 1, win 229, options [nop,nop,TS val 451059613 ecr 521897961], length 701</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:28:14.956014 IP server &gt; client.45068: Flags [.], ack 702, win 238, options [nop,nop,TS val 521897998 ecr 451059613], length 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:28:14.966435 IP server &gt; client.45068: Flags [P.], seq 1:591, ack 702, win 238, options [nop,nop,TS val 521898000 ecr 451059613], length 590</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:28:14.966439 IP client.45068 &gt; server: Flags [.], ack 591, win 238, options [nop,nop,TS val 451059653 ecr 521898000], length 0</span></div></div></div></div></div><p>开始释放请求
第一挥手</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:29:19.963379 IP server &gt; client.45068: Flags [F.], seq 591, ack 702, win 238, options [nop,nop,TS val 521914250 ecr 451059653], length 0</span></div></div></div></div></div><p>第二次挥手</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">13:29:20.001642 IP client.45068 &gt; server: Flags [.], ack 592, win 238, options [nop,nop,TS val 451075912 ecr 521914250], length 0</span></div></div></div></div></div><p>这个通信记录中,服务端发起挥手请求时进入CLOSE_WAIT状态,等待关闭,这个时候无法关闭应用,进程挂起 </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="xmind思维导图附件下载"></a>xmind思维导图附件下载<a aria-hidden="true" tabindex="-1" class="hash-link" href="#xmind思维导图附件下载" title="Direct link to heading">#</a></h2><p> <a href="../static/xmind/TCP%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82.xmind">TCP网络请求.xmind</a> </p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/mrg123/mrg123.github.io/edit/bak/docs\close-wait案例.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/命令行终端设置代理"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 命令行终端设置代理 windows / mac / linux</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/精准定位问题"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">如何分析问题?如何聪明的提问 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#问题" class="table-of-contents__link">问题</a></li><li><a href="#解决方案" class="table-of-contents__link">解决方案</a></li><li><a href="#临时的解决方案" class="table-of-contents__link">临时的解决方案</a></li><li><a href="#查看服务器当前tcp-close_wait状态的进程" class="table-of-contents__link">查看服务器当前TCP CLOSE_WAIT状态的进程</a></li><li><a href="#使用tcpdump命令导出请求日志" class="table-of-contents__link">使用tcpdump命令导出请求日志</a></li><li><a href="#tcp进程池满了apache错误日志" class="table-of-contents__link">tcp进程池满了apache错误日志</a></li><li><a href="#close_wait故障分析" class="table-of-contents__link">CLOSE_WAIT故障分析</a></li><li><a href="#tcp三次握手" class="table-of-contents__link">TCP三次握手</a></li><li><a href="#tcp四次挥手" class="table-of-contents__link">TCP四次挥手</a></li><li><a href="#tcp通信数据包分析" class="table-of-contents__link">TCP通信数据包分析</a></li><li><a href="#close_wait-tcp包通信请求分析" class="table-of-contents__link">CLOSE_WAIT TCP包通信请求分析</a></li><li><a href="#xmind思维导图附件下载" class="table-of-contents__link">xmind思维导图附件下载</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/doc1">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/mrg123/mrg123.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 Mrg123, Inc. Built with FB Docusaurus.</div></div></div></footer></div>
<script src="/styles.0dbef26b.js"></script>
<script src="/runtime~main.dca743ad.js"></script>
<script src="/main.3f0f9fa8.js"></script>
<script src="/1.cea16bf7.js"></script>
<script src="/2.628b2e7a.js"></script>
<script src="/3.40cc713f.js"></script>
<script src="/1be78505.8a2bda4b.js"></script>
<script src="/40.5f3e37f9.js"></script>
<script src="/20ac7829.4afa0427.js"></script>
<script src="/d30adc70.eec1c213.js"></script>
</body>
</html>